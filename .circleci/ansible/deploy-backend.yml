---

- name: "configuration play." 
  hosts: web
  user: ubuntu
  gather_facts: false
  vars:
    - ansible_python_interpreter: /usr/bin/python3
    - ansible_host_key_checking: false
    - ansible_stdout_callback: yaml
  roles:
    - deploy

- name: "add config"
  shell: |
    echo "[ssh_connection]" > ansible.cfg
    echo "scp_if_ssh=True" >> ansible.cfg

- name: "move files to server"
  become: true
  copy:
    src: /root/project/backend/dist
    dest: /home/ubuntu

- name: "install Node modules"
  shell: |
    cd /home/ubuntu/backend
    ls -la
    printenv
    npm install

- name: "building node services"
  shell: |
    cd /home/ubuntu/backend
    npm run build
    npm run prestart:prod

- name: "executing node"
  become: true
  shell: |
    cd /home/ubuntu/backend
    pm2 start npm --name backend -- start
    pm2 ls